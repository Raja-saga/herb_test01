#!/usr/bin/env python3\n\"\"\"\nDebug script to validate ViT model integration\nRun this to check if your ML pipeline is working correctly\n\"\"\"\n\nimport os\nimport json\nimport sys\nfrom PIL import Image\nimport torch\n\ndef validate_labels():\n    \"\"\"Check labels.json integrity\"\"\"\n    print(\"=== Validating Labels ===\")\n    try:\n        with open('labels.json', 'r') as f:\n            labels = json.load(f)\n        \n        print(f\"✓ Found {len(labels)} herb classes\")\n        print(f\"✓ Index range: 0 to {max(labels.values())}\")\n        \n        # Check for gaps in indices\n        indices = sorted(labels.values())\n        expected = list(range(len(labels)))\n        if indices != expected:\n            print(\"⚠ Warning: Non-continuous indices detected\")\n            print(f\"Expected: {expected[:5]}...\")\n            print(f\"Found: {indices[:5]}...\")\n        else:\n            print(\"✓ Indices are continuous\")\n        \n        return labels\n    except Exception as e:\n        print(f\"✗ Labels validation failed: {e}\")\n        return None\n\ndef validate_model():\n    \"\"\"Check model loading\"\"\"\n    print(\"\\n=== Validating Model ===\")\n    try:\n        from transformers import ViTImageProcessor, ViTForImageClassification\n        \n        # Check processor\n        processor = ViTImageProcessor.from_pretrained('google/vit-base-patch16-224')\n        print(\"✓ Processor loaded successfully\")\n        \n        # Check model architecture\n        model = ViTForImageClassification.from_pretrained(\n            'google/vit-base-patch16-224',\n            num_labels=74,\n            ignore_mismatched_sizes=True\n        )\n        print(\"✓ Model architecture loaded\")\n        \n        # Check for trained weights\n        model_path = 'model/vit_herb_model.pth'\n        if os.path.exists(model_path):\n            try:\n                state_dict = torch.load(model_path, map_location='cpu')\n                model.load_state_dict(state_dict)\n                print(\"✓ Trained weights loaded successfully\")\n            except Exception as e:\n                print(f\"⚠ Warning: Could not load trained weights: {e}\")\n                print(\"  Using base ViT model instead\")\n        else:\n            print(f\"⚠ Warning: No trained weights found at {model_path}\")\n            print(\"  Using base ViT model\")\n        \n        return processor, model\n    except Exception as e:\n        print(f\"✗ Model validation failed: {e}\")\n        return None, None\n\ndef test_prediction(processor, model, labels):\n    \"\"\"Test prediction pipeline\"\"\"\n    print(\"\\n=== Testing Prediction Pipeline ===\")\n    \n    # Create a dummy image\n    dummy_image = Image.new('RGB', (224, 224), color='green')\n    dummy_path = 'test_image.jpg'\n    dummy_image.save(dummy_path)\n    \n    try:\n        # Test preprocessing\n        image = Image.open(dummy_path).convert('RGB')\n        image = image.resize((224, 224), Image.LANCZOS)\n        inputs = processor(images=image, return_tensors=\"pt\")\n        print(\"✓ Image preprocessing successful\")\n        print(f\"  Input shape: {inputs['pixel_values'].shape}\")\n        \n        # Test inference\n        model.eval()\n        with torch.no_grad():\n            outputs = model(**inputs)\n            predictions = torch.nn.functional.softmax(outputs.logits, dim=-1)\n            confidence = torch.max(predictions).item() * 100\n            predicted_class = torch.argmax(predictions).item()\n        \n        print(\"✓ Model inference successful\")\n        print(f\"  Predicted class: {predicted_class}\")\n        print(f\"  Confidence: {confidence:.2f}%\")\n        \n        # Test label mapping\n        reverse_labels = {v: k for k, v in labels.items()}\n        herb_name = reverse_labels.get(predicted_class, \"Unknown\")\n        print(f\"  Mapped herb: {herb_name}\")\n        \n        # Cleanup\n        os.remove(dummy_path)\n        \n        return True\n    except Exception as e:\n        print(f\"✗ Prediction test failed: {e}\")\n        if os.path.exists(dummy_path):\n            os.remove(dummy_path)\n        return False\n\ndef main():\n    print(\"Herb Recognition ML Pipeline Validator\")\n    print(\"=\" * 40)\n    \n    # Change to ml_service directory\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n    os.chdir(script_dir)\n    \n    # Run validations\n    labels = validate_labels()\n    if not labels:\n        sys.exit(1)\n    \n    processor, model = validate_model()\n    if not processor or not model:\n        sys.exit(1)\n    \n    success = test_prediction(processor, model, labels)\n    if not success:\n        sys.exit(1)\n    \n    print(\"\\n\" + \"=\" * 40)\n    print(\"✅ All validations passed!\")\n    print(\"Your ML pipeline should work correctly.\")\n\nif __name__ == \"__main__\":\n    main()